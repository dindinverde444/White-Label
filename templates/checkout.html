<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} - Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a0b;
        }
        .bg-rublion-dark { background-color: #0a0a0b; }
        .bg-rublion-card { background-color: #161618; }
        .text-rublion-pink { color: #f472b6; }
        .bg-rublion-pink { background-color: #f472b6; }
        .border-rublion-pink { border-color: #f472b6; }
        .gradient-rublion { 
            background: linear-gradient(135deg, #f472b6, #ec4899, #be185d);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rublion: {
                            dark: '#0a0a0b',
                            card: '#161618',
                            pink: '#f472b6'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-rublion-dark text-white min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-rublion p-6">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-white">{{ product.header }}</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <div class="max-w-4xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Product Info -->
                    <div class="bg-rublion-card rounded-xl p-6 border border-gray-800">
                        <div class="text-center mb-6">
                            {% if product.product_image %}
                                <img src="/uploads/{{ product.product_image }}" 
                                     alt="{{ product.name }}" 
                                     class="w-full h-64 object-cover rounded-lg mb-4">
                            {% else %}
                                <div class="w-full h-64 bg-gray-700 rounded-lg mb-4 flex items-center justify-center">
                                    <i data-lucide="package" class="w-16 h-16 text-gray-500"></i>
                                </div>
                            {% endif %}
                            
                            <h2 class="text-3xl font-bold text-white mb-2">{{ product.name }}</h2>
                            <p class="text-4xl font-bold text-rublion-pink mb-4">
                                R$ {{ "%.2f"|format(product.price)|replace(".", ",") }}
                            </p>
                        </div>

                        <!-- Product Details -->
                        <div class="space-y-4">
                            {% if product.warranty_time and product.warranty_unit %}
                                <div class="flex items-center space-x-3 text-gray-300">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-green-400"></i>
                                    <span>Garantia de {{ product.warranty_time }} {{ product.warranty_unit }}</span>
                                </div>
                            {% endif %}
                            
                            {% if product.support_email %}
                                <div class="flex items-center space-x-3 text-gray-300">
                                    <i data-lucide="mail" class="w-5 h-5 text-blue-400"></i>
                                    <span>Suporte: {{ product.support_email }}</span>
                                </div>
                            {% endif %}
                            
                            <div class="flex items-center space-x-3 text-gray-300">
                                <i data-lucide="user" class="w-5 h-5 text-purple-400"></i>
                                <span>Vendedor: {{ product.seller_name }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout Form -->
                    <div class="bg-rublion-card rounded-xl p-6 border border-gray-800">
                        <h3 class="text-xl font-bold text-white mb-6">Complete sua Compra</h3>
                        
                        <form id="checkout-form" class="space-y-4">
                            <!-- Customer Info -->
                            <div>
                                <label class="block text-sm font-medium text-white mb-2">Nome Completo</label>
                                <input type="text" id="customer-name" required 
                                       class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-rublion-pink focus:outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-white mb-2">E-mail</label>
                                <input type="email" id="customer-email" required 
                                       class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-rublion-pink focus:outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-white mb-2">CPF</label>
                                <input type="text" id="customer-cpf" required 
                                       class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-rublion-pink focus:outline-none"
                                       placeholder="000.000.000-00">
                            </div>

                            <!-- Payment Method -->
                            <div>
                                <label class="block text-sm font-medium text-white mb-2">Forma de Pagamento</label>
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" id="pix" name="payment-method" value="pix" checked
                                               class="w-4 h-4 text-rublion-pink bg-gray-800 border-gray-600 focus:ring-rublion-pink">
                                        <label for="pix" class="flex items-center space-x-2 text-white">
                                            <i data-lucide="zap" class="w-4 h-4 text-blue-400"></i>
                                            <span>PIX (Aprovação Instantânea)</span>
                                        </label>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" id="credit-card" name="payment-method" value="credit"
                                               class="w-4 h-4 text-rublion-pink bg-gray-800 border-gray-600 focus:ring-rublion-pink">
                                        <label for="credit-card" class="flex items-center space-x-2 text-white">
                                            <i data-lucide="credit-card" class="w-4 h-4 text-purple-400"></i>
                                            <span>Cartão de Crédito</span>
                                        </label>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" id="boleto" name="payment-method" value="boleto"
                                               class="w-4 h-4 text-rublion-pink bg-gray-800 border-gray-600 focus:ring-rublion-pink">
                                        <label for="boleto" class="flex items-center space-x-2 text-white">
                                            <i data-lucide="file-text" class="w-4 h-4 text-orange-400"></i>
                                            <span>Boleto Bancário</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <span class="text-lg font-medium text-white">Total:</span>
                                    <span class="text-2xl font-bold text-rublion-pink">
                                        R$ {{ "%.2f"|format(product.price)|replace(".", ",") }}
                                    </span>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" 
                                    class="w-full bg-rublion-pink hover:bg-rublion-pink/80 px-6 py-3 rounded-lg text-white font-bold text-lg transition-colors">
                                <i data-lucide="shopping-cart" class="w-5 h-5 inline mr-2"></i>
                                Finalizar Compra
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Product Banners -->
                {% if product.product_banner %}
                    <div class="mt-8">
                        <img src="/uploads/{{ product.product_banner }}" 
                             alt="Banner do produto" 
                             class="w-full h-48 object-cover rounded-xl">
                    </div>
                {% endif %}
                
                {% if product.final_banner %}
                    <div class="mt-8">
                        <img src="/uploads/{{ product.final_banner }}" 
                             alt="Banner final" 
                             class="w-full h-48 object-cover rounded-xl">
                    </div>
                {% endif %}
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 p-6 mt-12">
            <div class="max-w-4xl mx-auto text-center">
                <p class="text-gray-400">
                    Compra segura processada por Gateway Pay
                </p>
                {% if product.support_email %}
                    <p class="text-gray-500 text-sm mt-2">
                        Dúvidas? Entre em contato: {{ product.support_email }}
                    </p>
                {% endif %}
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Máscara para CPF
            const cpfInput = document.getElementById('customer-cpf');
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            });
            
            // Submit do formulário
            document.getElementById('checkout-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                
                if (paymentMethod === 'pix') {
                    // Processar PIX
                    processPixPayment();
                } else {
                    // Outros métodos de pagamento
                    alert('Outros métodos de pagamento serão implementados em breve!');
                }
            });
            
            async function processPixPayment() {
                try {
                    // Mostrar loading
                    const submitBtn = document.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 inline mr-2 animate-spin"></i>Processando...';
                    submitBtn.disabled = true;
                    
                    const paymentData = {
                        amount: {{ product.price }},
                        customer_name: document.getElementById('customer-name').value,
                        customer_email: document.getElementById('customer-email').value,
                        customer_phone: document.getElementById('customer-cpf').value, // Usando CPF como telefone temporariamente
                        product_id: '{{ product.product_id }}',
                        product_name: '{{ product.name }}'
                    };
                    
                    const response = await fetch('/api/pix/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Mostrar QR Code PIX
                        showPixQRCode(result);
                    } else {
                        alert('Erro ao gerar PIX: ' + result.error);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                    
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro de conexão. Tente novamente.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
            
            function showPixQRCode(paymentData) {
                // Criar modal com QR Code
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-900 rounded-xl p-8 max-w-md w-full mx-4">
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-white mb-4">Pagamento PIX</h3>
                            <p class="text-gray-400 mb-6">Escaneie o QR Code para pagar</p>
                            
                            <div class="bg-white p-4 rounded-lg mb-4">
                                <img src="data:image/png;base64,${paymentData.qr_code_image}" 
                                     alt="QR Code PIX" 
                                     class="w-48 h-48 mx-auto">
                            </div>
                            
                            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                                <p class="text-sm text-gray-400 mb-2">Código PIX:</p>
                                <p class="text-white font-mono text-sm break-all">${paymentData.pix_code}</p>
                            </div>
                            
                            <div class="flex items-center justify-between mb-6">
                                <span class="text-gray-400">Valor:</span>
                                <span class="text-2xl font-bold text-green-400">R$ ${paymentData.amount.toFixed(2).replace('.', ',')}</span>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="checkPaymentStatus('${paymentData.payment_id}')" 
                                        class="flex-1 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-white font-medium">
                                    Verificar Pagamento
                                </button>
                                <button onclick="closePixModal()" 
                                        class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-white font-medium">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Iniciar verificação automática
                startPaymentCheck(paymentData.payment_id);
            }
            
            function closePixModal() {
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) {
                    modal.remove();
                }
                
                // Restaurar botão
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i data-lucide="shopping-cart" class="w-5 h-5 inline mr-2"></i>Finalizar Compra';
                submitBtn.disabled = false;
            }
            
            let paymentCheckInterval;
            
            function startPaymentCheck(paymentId) {
                // Verificar a cada 5 segundos
                paymentCheckInterval = setInterval(() => {
                    checkPaymentStatus(paymentId);
                }, 5000);
            }
            
            async function checkPaymentStatus(paymentId) {
                try {
                    const response = await fetch(`/api/pix/status/${paymentId}`);
                    const result = await response.json();
                    
                    if (result.success && result.is_paid) {
                        clearInterval(paymentCheckInterval);
                        alert('Pagamento confirmado! Redirecionando...');
                        window.location.href = '{{ product.thank_page_url or "/payment/success" }}';
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }
        });
    </script>
</body>
</html>
